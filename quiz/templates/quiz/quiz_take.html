{% extends 'quiz/base.html' %}
{% load static %}

{% block title %}Taking {{ quiz.title }} - Quiz Application{% endblock %}

{% block extra_css %}
<style>
    .quiz-container {
        max-width: 900px;
        margin: 0 auto;
    }
    .timer-box {
        position: sticky;
        top: 20px;
        z-index: 100;
    }
    .question-card {
        border-left: 4px solid #0d6efd;
    }
    .choice-label {
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
    }
    .choice-label:hover {
        background-color: #f8f9fa;
        border-color: #0d6efd;
    }
    .choice-label input[type="radio"]:checked + span {
        font-weight: bold;
        color: #0d6efd;
    }
    .question-nav {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }
    .question-nav-btn {
        width: 40px;
        height: 40px;
        padding: 0;
        font-size: 14px;
    }
    .answered {
        background-color: #198754 !important;
        border-color: #198754 !important;
        color: white !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="quiz-container">
    <!-- Timer and Progress -->
    <div class="card timer-box mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <h5 class="mb-0">{{ quiz.title }}</h5>
                </div>
                <div class="col-md-4 text-center">
                    <div class="timer" id="timer">
                        <i class="fas fa-clock text-warning"></i>
                        <span id="time-remaining" class="fs-4 fw-bold">--:--</span>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar" id="progress-bar" role="progressbar" 
                             style="width: 0%">0%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quiz Form -->
    <form id="quiz-form">
        {% csrf_token %}
        {% for question in questions %}
        <div class="question-section card question-card mb-4" data-question="{{ forloop.counter }}" 
             style="{% if forloop.counter > 1 %}display: none;{% endif %}">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Question {{ forloop.counter }} of {{ questions.count }}</h5>
                    <span class="badge bg-light text-dark">{{ question.marks }} marks</span>
                </div>
            </div>
            <div class="card-body">
                <h5 class="mb-4">{{ question.question_text }}</h5>
                
                {% for choice in question.choices.all %}
                <label class="choice-label d-block">
                    <input type="radio" name="question_{{ question.id }}" 
                           value="{{ choice.id }}" class="me-2" required>
                    <span>{{ forloop.counter }}. {{ choice.choice_text }}</span>
                </label>
                {% endfor %}
            </div>
            <div class="card-footer bg-transparent">
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary prev-btn" 
                            {% if forloop.first %}disabled{% endif %}>
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    
                    {% if forloop.last %}
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" 
                            data-bs-target="#submitModal">
                        <i class="fas fa-check"></i> Submit Quiz
                    </button>
                    {% else %}
                    <button type="button" class="btn btn-primary next-btn">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </form>
    
    <!-- Question Navigation -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-list"></i> Question Navigation</h6>
        </div>
        <div class="card-body">
            <div class="question-nav">
                {% for question in questions %}
                <button type="button" class="btn btn-outline-primary question-nav-btn" 
                        data-question="{{ forloop.counter }}">
                    {{ forloop.counter }}
                </button>
                {% endfor %}
            </div>
            <div class="mt-3">
                <small class="text-muted">
                    <span class="badge bg-success">Green</span> = Answered | 
                    <span class="badge bg-outline-primary">Blue</span> = Not Answered
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Submit Confirmation Modal -->
<div class="modal fade" id="submitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Confirm Submission
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to submit the quiz?</p>
                <p class="mb-0"><strong>Note:</strong> You won't be able to change your answers after submission.</p>
                <div class="mt-3" id="submission-summary">
                    <p class="mb-1">Answered: <span id="answered-count" class="fw-bold">0</span> / {{ questions.count }}</p>
                    <p class="mb-0">Unanswered: <span id="unanswered-count" class="fw-bold">{{ questions.count }}</span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-success" id="final-submit-btn">
                    <i class="fas fa-check"></i> Yes, Submit
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const quizId = {{ quiz.id }};
    const totalQuestions = {{ questions.count }};
    let remainingTime = {{ remaining_time }};
    let currentQuestion = 1;
    let timerInterval;
    
    // Initialize timer
    function startTimer() {
        updateTimerDisplay();
        timerInterval = setInterval(() => {
            remainingTime--;
            updateTimerDisplay();
            
            if (remainingTime <= 0) {
                clearInterval(timerInterval);
                alert('Time is up! Submitting quiz...');
                submitQuiz();
            }
        }, 1000);
    }
    
    function updateTimerDisplay() {
        const minutes = Math.floor(remainingTime / 60);
        const seconds = remainingTime % 60;
        document.getElementById('time-remaining').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Change color when time is running out
        if (remainingTime <= 60) {
            document.getElementById('time-remaining').classList.add('text-danger');
        }
    }
    
    // Navigation
    function showQuestion(questionNum) {
        document.querySelectorAll('.question-section').forEach(section => {
            section.style.display = 'none';
        });
        document.querySelector(`[data-question="${questionNum}"]`).style.display = 'block';
        currentQuestion = questionNum;
        updateProgress();
    }
    
    // Next/Previous buttons
    document.querySelectorAll('.next-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            if (currentQuestion < totalQuestions) {
                showQuestion(currentQuestion + 1);
            }
        });
    });
    
    document.querySelectorAll('.prev-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            if (currentQuestion > 1) {
                showQuestion(currentQuestion - 1);
            }
        });
    });
    
    // Question navigation buttons
    document.querySelectorAll('.question-nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const questionNum = parseInt(btn.dataset.question);
            showQuestion(questionNum);
        });
    });
    
    // Mark answered questions
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', () => {
            updateAnsweredQuestions();
        });
    });
    
    function updateAnsweredQuestions() {
        const answeredQuestions = new Set();
        document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
            const questionNum = parseInt(radio.closest('.question-section').dataset.question);
            answeredQuestions.add(questionNum);
        });
        
        document.querySelectorAll('.question-nav-btn').forEach((btn, index) => {
            if (answeredQuestions.has(index + 1)) {
                btn.classList.add('answered');
                btn.classList.remove('btn-outline-primary');
            }
        });
        
        // Update submission summary
        document.getElementById('answered-count').textContent = answeredQuestions.size;
        document.getElementById('unanswered-count').textContent = totalQuestions - answeredQuestions.size;
        
        updateProgress();
    }
    
    function updateProgress() {
        const answeredCount = document.querySelectorAll('input[type="radio"]:checked').length;
        const percentage = Math.round((answeredCount / totalQuestions) * 100);
        const progressBar = document.getElementById('progress-bar');
        progressBar.style.width = percentage + '%';
        progressBar.textContent = percentage + '%';
    }
    
    // Submit quiz
    document.getElementById('final-submit-btn').addEventListener('click', () => {
        submitQuiz();
    });
    
    function submitQuiz() {
        const formData = new FormData(document.getElementById('quiz-form'));
        const answers = {};
        
        formData.forEach((value, key) => {
            if (key.startsWith('question_')) {
                const questionId = key.replace('question_', '');
                answers[questionId] = value;
            }
        });
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Submit via AJAX
        fetch('/quiz/submit/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                quiz_id: quizId,
                answers: answers
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                clearInterval(timerInterval);
                window.location.href = data.redirect_url;
            } else {
                alert('Error submitting quiz: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while submitting the quiz.');
        });
    }
    
    // Start timer on page load
    startTimer();
    updateProgress();
</script>
{% endblock %}